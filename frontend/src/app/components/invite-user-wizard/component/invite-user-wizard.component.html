<div [formGroup]="form" class="form-container" (keydown.enter)="nextAction(this.currentStep)">
  <h2>
    {{text.invite}} {{form.get('user')?.value?.name || text.user}} {{text.to}} {{project}}
  </h2>

  <op-stepper (selectionChange)="currentStepIndex = $event.selectedIndex">
    <op-step *ngFor="let step of steps;">
        <!--SELECT TEMPLATE-->
        <ng-container *ngIf="step.type === 'select'">
          <label [for]="step.formControlName">{{step.label()}}</label>

          <ng-select [formControlName]="step.formControlName"
                     [typeahead]="input$"
                     [items]="items$ | async"
                     [virtualScroll]="true"
                     required="true"
                     [clearable]="true"
                     [clearOnBackspace]="true"
                     [clearSearchOnAdd]="false"
                     [bindLabel]="step.bindLabel"
                     [multiple]="false"
                     [labelForId]="step.formControlName"
                     #ngselect>
            <!--SELECT OPTIONS TEMPLATES-->
            <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
              <span [ngOptionHighlight]="search" class="ng-option-label ellipsis">
                {{ item.name }}
              </span>

              <span *ngIf="inputIsEmail(currentNgSelectInput.value)">
                ({{item.email}})
              </span>

              <span *ngIf="item.disabled">
                ({{text.alreadyMemberMessage}} {{project}})
              </span>
            </ng-template>

            <!--SELECT NOT FOUND TEMPLATE-->
            <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
              <div class="ng-option ng-option-disabled" *ngIf="!inputIsEmail(currentNgSelectInput.value)">
                {{text.noDataFoundFor}} "{{searchTerm}}"
              </div>
            </ng-template>

            <!--SELECT INVITE BY EMAIL TEMPLATE-->
            <ng-template ng-footer-tmp>
              <div *ngIf="step.showInviteUserByEmail && inputIsEmail(currentNgSelectInput.value) && !(items$ | async)?.length">
                <button class="button"
                        (click)="setUserEmail(currentNgSelectInput.value)"
                        [disabled]="!inputIsValidEmail(currentNgSelectInput.value)">
                  <op-icon icon-classes="icon-mail1"></op-icon>

                  {{text.invite}}: {{currentNgSelectInput.value}}
                </button>
              </div>
            </ng-template>
          </ng-select>

          <p class="description"
             *ngIf="step.description">
            {{step.description()}}

            <a *ngIf="step.link"
               [href]="step.link.href"
               target="_blank">
              {{step.link.text}}
            </a>
          </p>
        </ng-container>

        <!--TEXTAREA TEMPLATE-->
        <ng-container *ngIf="step.type === 'textarea'">
          <label [for]="step.formControlName">
            {{step.label()}}
          </label>

          <textarea [formControlName]="step.formControlName"
                    [id]="step.formControlName"
                    #textarea>
          </textarea>

          <p class="description"
             *ngIf="step.description">
            {{step.description()}}
          </p>
        </ng-container>

        <!--SUMMARY TEMPLATE-->
        <ng-container *ngIf="step.type === 'summary'">
          <div *ngFor="let step of steps"
               [ngClass]="['summary-field', 'summary-field' + '-' + step.formControlName]">
            <ng-container *ngIf="step.formControlName">
              <p>
                <strong>{{step.summaryLabel}}</strong>
              </p>

              <p>
                {{form.get(step.formControlName).value?.name || form.get(step.formControlName).value}}
              </p>
            </ng-container>
          </div>
        </ng-container>

        <!--CONFIRMATION TEMPLATE-->
        <ng-container *ngIf="step.type === 'confirmation'">
          <p class="description"
             *ngIf="step.description">
            {{step.description()}}
          </p>
        </ng-container>
    </op-step>
  </op-stepper>

  <div class="buttons-container">
    <button class="button button-left"
            (click)="previousAction()"
            *ngIf="currentStep?.previousButtonText"
            [disabled]="!currentStepIndex">
      {{currentStep?.previousButtonText}}
    </button>

    <button class="button button-right"
            (click)="nextAction(currentStep)"
            *ngIf="currentStep?.nextButtonText"
            [disabled]="shouldBeDisabled(currentStep)">
      {{currentStep?.nextButtonText}}
    </button>
  </div>
</div>
